# 台灣縣市合併對應表與修復建議

## 檢查結果摘要

### ✅ 好消息
1. **縣市合併已完成**：GeoJSON 和病例資料都已經使用合併後的縣市名稱
2. **沒有舊縣市名稱**：資料中沒有「臺中縣」、「臺南縣」、「高雄縣」、「臺北縣」等舊名稱
3. **行政區數量基本匹配**：高雄市完全匹配（38個），台南市幾乎完全匹配（37 vs 36）

### ⚠️ 發現的問題

#### 1. 「台」vs「臺」的命名不一致

**GeoJSON 使用**：`臺`（繁體字）
- 臺南市
- 臺中市
- 臺北市
- 臺東縣

**病例資料使用**：`台`（簡化字）
- 台南市
- 台中市
- 台北市
- 台東縣

**影響**：這會導致地圖匹配失敗！

#### 2. 行政區數量差異

**台南市**：
- GeoJSON：37 個行政區
- 病例資料：36 個行政區
- 缺少：北門區（可能是該區沒有病例）

**高雄市**：
- GeoJSON：38 個行政區
- 病例資料：38 個行政區
- ✅ 完全匹配

## 縣市合併規則（2010年）

| 合併前 | 合併後 | 說明 |
|--------|--------|------|
| 臺中縣 + 臺中市 | 臺中市 | 縣市合併 |
| 臺南縣 + 臺南市 | 臺南市 | 縣市合併 |
| 高雄縣 + 高雄市 | 高雄市 | 縣市合併 |
| 臺北縣 | 新北市 | 改名升格 |

## 目前資料狀態

### GeoJSON 檔案
- ✅ 使用合併後的縣市名稱
- ✅ 使用「臺」（繁體字）
- ✅ 22 個縣市
- ✅ 368 個行政區

### 病例資料（原始資料）
- ✅ 使用合併後的縣市名稱
- ⚠️ 使用「台」（簡化字）
- ✅ 22 個縣市
- ✅ 107,514 筆病例

### 病例資料（處理過的資料）
- ✅ 使用合併後的縣市名稱
- ⚠️ 使用「台」（簡化字）
- ✅ 23 個縣市（包含「未知」）

## 需要對應的檔案

### 1. 資料處理階段（`src/analyze_dengue.py`）
需要在分析時統一命名：
```python
# 統一「台」vs「臺」
df['居住縣市'] = df['居住縣市'].str.replace('台', '臺')
df['居住縣市'] = df['居住縣市'].str.replace('台南', '臺南')
df['居住縣市'] = df['居住縣市'].str.replace('台中', '臺中')
df['居住縣市'] = df['居住縣市'].str.replace('台北', '臺北')
df['居住縣市'] = df['居住縣市'].str.replace('台東', '臺東')
```

### 2. 後端 API（`website/app.py`）
已在 `filter_data_by_county` 和 `generate_complete_township_data` 中處理：
- ✅ 處理「台」vs「臺」的差異
- ✅ 處理縣市名稱匹配

### 3. 前端 JavaScript（`website/static/js/county.js`）
已在 `renderCountyMap` 中處理：
- ✅ 處理「台」vs「臺」的差異
- ✅ 模糊匹配行政區名稱

## 數量統計對比

### 台南市
| 項目 | GeoJSON | 病例資料 | 差異 |
|------|---------|----------|------|
| 行政區數 | 37 | 36 | -1（缺少北門區） |
| 縣市名稱 | 臺南市 | 台南市 | 命名不一致 |

### 高雄市
| 項目 | GeoJSON | 病例資料 | 差異 |
|------|---------|----------|------|
| 行政區數 | 38 | 38 | 0（完全匹配） |
| 縣市名稱 | 高雄市 | 高雄市 | ✅ 一致 |

## 修復建議

### 方案 A：在資料分析階段統一命名（推薦）

修改 `src/analyze_dengue.py`，在讀取資料後立即統一命名：

```python
def normalize_county_names(df):
    """統一縣市名稱（處理「台」vs「臺」和縣市合併）"""
    # 統一為「臺」
    df['居住縣市'] = df['居住縣市'].str.replace('台', '臺', regex=False)
    
    # 應用縣市合併規則
    county_merger_map = {
        '臺中縣': '臺中市',
        '臺南縣': '臺南市',
        '高雄縣': '高雄市',
        '臺北縣': '新北市',
    }
    df['居住縣市'] = df['居住縣市'].replace(county_merger_map)
    
    return df
```

### 方案 B：在後端 API 中處理（已實施）

已在 `website/app.py` 中實施，但建議在資料分析階段就統一。

### 方案 C：建立對應表檔案

建立 `county_name_mapping.json`：

```json
{
  "台": "臺",
  "台南": "臺南",
  "台中": "臺中",
  "台北": "臺北",
  "台東": "臺東",
  "臺中縣": "臺中市",
  "臺南縣": "臺南市",
  "高雄縣": "高雄市",
  "臺北縣": "新北市"
}
```

## 檢查腳本

已建立 `check_county_merger_mapping.py` 用於檢查：
- 縣市合併對應
- 「台」vs「臺」的差異
- 行政區數量對比
- 命名一致性

## 建議行動

1. **立即修復**：在 `src/analyze_dengue.py` 中添加命名統一邏輯
2. **重新分析資料**：執行分析腳本生成新的 `dengue_analysis.json`
3. **驗證**：使用檢查腳本驗證修復結果
4. **測試地圖**：確認台南和高雄地圖正常顯示

## 相關檔案

- `check_county_merger_mapping.py` - 檢查腳本
- `src/analyze_dengue.py` - 需要修改的資料分析腳本
- `website/app.py` - 已處理命名差異的後端
- `website/static/js/county.js` - 已處理命名差異的前端

