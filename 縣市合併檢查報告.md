# 台灣縣市合併檢查報告

## 執行日期
檢查時間：2025年

## 檢查結果摘要

### ✅ 縣市合併狀態
- **GeoJSON 檔案**：已使用合併後的縣市名稱（22個縣市）
- **病例資料（原始）**：已使用合併後的縣市名稱（22個縣市）
- **病例資料（處理後）**：已使用合併後的縣市名稱（23個縣市，包含「未知」）

**結論**：所有資料都已使用2010年合併後的縣市名稱，沒有舊縣市名稱。

### ⚠️ 發現的問題

#### 問題 1：「台」vs「臺」的命名不一致

| 資料來源 | 使用字體 | 範例 |
|---------|---------|------|
| GeoJSON | 繁體「臺」 | 臺南市、臺中市、臺北市 |
| 病例資料 | 簡化「台」 | 台南市、台中市、台北市 |

**影響**：會導致地圖匹配失敗，因為名稱不一致。

**修復狀態**：
- ✅ 已在 `src/analyze_dengue.py` 中添加 `normalize_county_names()` 函數
- ✅ 已在 `website/app.py` 中處理命名差異
- ✅ 已在 `website/static/js/county.js` 中處理命名差異

#### 問題 2：行政區數量差異

**台南市**：
- GeoJSON：37 個行政區
- 病例資料：36 個行政區
- 差異：缺少「北門區」（可能是該區沒有病例，屬於正常情況）

**高雄市**：
- GeoJSON：38 個行政區
- 病例資料：38 個行政區
- 差異：✅ 完全匹配

## 縣市合併規則（2010年）

| 合併前 | 合併後 | 類型 |
|--------|--------|------|
| 臺中縣 + 臺中市 | 臺中市 | 縣市合併 |
| 臺南縣 + 臺南市 | 臺南市 | 縣市合併 |
| 高雄縣 + 高雄市 | 高雄市 | 縣市合併 |
| 臺北縣 | 新北市 | 改名升格 |

## 資料統計

### GeoJSON 檔案統計
- 總縣市數：22 個
- 總行政區數：368 個
- 主要縣市：
  - 高雄市：38 個行政區
  - 臺南市：37 個行政區
  - 屏東縣：33 個行政區
  - 臺中市：29 個行政區
  - 新北市：29 個行政區

### 病例資料統計
- 總病例數：107,514 例
- 總縣市數：22 個（不含「未知」）
- 主要縣市病例數：
  - 高雄市：49,280 例
  - 台南市：48,405 例
  - 屏東縣：2,624 例
  - 新北市：1,317 例
  - 台北市：1,196 例

## 已實施的修復

### 1. 資料分析階段（`src/analyze_dengue.py`）
```python
def normalize_county_names(df):
    """統一縣市名稱（處理「台」vs「臺」和縣市合併）"""
    # 統一為「臺」（繁體字），與 GeoJSON 保持一致
    df['居住縣市'] = df['居住縣市'].astype(str).str.replace('台', '臺', regex=False)
    
    # 應用縣市合併規則（2010年合併）
    county_merger_map = {
        '臺中縣': '臺中市',
        '臺南縣': '臺南市',
        '高雄縣': '高雄市',
        '臺北縣': '新北市',
    }
    df['居住縣市'] = df['居住縣市'].replace(county_merger_map)
    
    return df
```

### 2. 後端 API（`website/app.py`）
- ✅ `filter_data_by_county()` 函數已處理「台」vs「臺」的差異
- ✅ `generate_complete_township_data()` 函數已處理命名匹配

### 3. 前端 JavaScript（`website/static/js/county.js`）
- ✅ `renderCountyMap()` 函數已處理「台」vs「臺」的差異
- ✅ 已實現模糊匹配邏輯

## 需要對應的檔案清單

### 必須處理的檔案
1. ✅ `src/analyze_dengue.py` - 已添加命名統一功能
2. ✅ `website/app.py` - 已處理命名差異
3. ✅ `website/static/js/county.js` - 已處理命名差異

### 資料檔案
1. `data/raw/Dengue_Daily.csv` - 原始資料（保持原樣，在分析時統一）
2. `data/processed/dengue_analysis.json` - 處理後的資料（需要重新生成）
3. `website/static/data/taiwan_township.geojson` - GeoJSON 檔案（已正確）

## 建議的後續步驟

### 立即執行
1. **重新執行資料分析**：
   ```bash
   python src/analyze_dengue.py
   ```
   這會生成新的 `dengue_analysis.json`，其中縣市名稱已統一為「臺」

2. **驗證修復結果**：
   ```bash
   python check_county_merger_mapping.py
   ```

3. **測試地圖顯示**：
   - 重新啟動 Flask 伺服器
   - 訪問台南市和高雄市專頁
   - 確認地圖正常顯示

### 長期維護
1. **建立命名對應表**：建立 `county_name_mapping.json` 檔案
2. **文檔化**：在 README 中說明命名規則
3. **自動化檢查**：在 CI/CD 流程中加入命名一致性檢查

## 檢查腳本

已建立以下檢查腳本：
- `check_county_merger_mapping.py` - 檢查縣市合併和命名對應
- `check_map_matching.py` - 檢查地圖匹配問題
- `check_map_issue_fix.py` - 檢查地圖修復狀態

## 結論

1. ✅ **縣市合併已完成**：所有資料都使用合併後的縣市名稱
2. ⚠️ **命名不一致**：GeoJSON 使用「臺」，病例資料使用「台」
3. ✅ **已實施修復**：在資料分析、後端和前端都已處理命名差異
4. ✅ **行政區匹配良好**：高雄市完全匹配，台南市幾乎完全匹配

**建議**：重新執行資料分析以生成統一命名的資料檔案。

