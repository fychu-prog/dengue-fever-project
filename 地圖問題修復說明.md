# 台南和高雄地圖無法顯示問題修復說明

## 問題診斷

經過檢查，發現問題的根本原因是：

1. **資料結構問題**：病例資料中只有 `township_top30`（前 30 名行政區），但地圖需要顯示所有行政區
2. **匹配問題**：行政區名稱匹配正常，但因為只有部分行政區有資料，導致地圖無法完整顯示

## 檢查結果

### 行政區數量對比

- **台南市**：
  - GeoJSON 中有 37 個行政區
  - 病例資料中只有 11 個行政區（top 30 中屬於台南市的）
  - 完全匹配的行政區：11 個

- **高雄市**：
  - GeoJSON 中有 38 個行政區
  - 病例資料中只有 17 個行政區（top 30 中屬於高雄市的）
  - 完全匹配的行政區：17 個

### 變項名稱檢查

- GeoJSON 使用：`COUNTYNAME`（縣市名稱）、`TOWNNAME`（行政區名稱）
- 病例資料使用：`居住縣市`、`居住鄉鎮`、`病例數`
- **變項名稱匹配正常**，問題不在於變項名稱

## 解決方案

### 已實施的修復

1. **修改 `website/app.py`**：
   - 新增 `generate_complete_township_data()` 函數
   - 從 GeoJSON 讀取該縣市的所有行政區
   - 從原始資料計算每個行政區的病例數
   - 生成完整的行政區列表（包含所有行政區，即使病例數為 0）

2. **修改 `filter_data_by_county()` 函數**：
   - 使用 `generate_complete_township_data()` 生成完整列表
   - 保留 `township_top30` 用於其他用途（如表格顯示）

### 修復後的資料結構

```python
filtered['location']['township'] = [
    {
        '居住縣市': '台南市',
        '居住鄉鎮': '北區',
        '病例數': 9320
    },
    # ... 所有 37 個行政區 ...
    {
        '居住縣市': '台南市',
        '居住鄉鎮': '龍崎區',
        '病例數': 0  # 即使沒有病例也會包含
    }
]
```

## 測試建議

1. **重新啟動 Flask 伺服器**
2. **訪問台南市和高雄市專頁**
3. **檢查瀏覽器控制台**：
   - 應該看到 "過濾鄉鎮資料: 找到 X 筆 top30 記錄，完整列表 Y 筆"
   - Y 應該是 37（台南市）或 38（高雄市）
4. **檢查地圖**：
   - 應該能看到所有行政區
   - 即使病例數為 0 的行政區也應該顯示（顏色較淺）

## 相關檔案

- `check_map_matching.py` - 檢查腳本（診斷問題）
- `check_map_issue_fix.py` - 修復檢查腳本（驗證修復）
- `website/app.py` - 已修復的後端程式碼

## 注意事項

- 確保 `website/static/data/taiwan_township.geojson` 檔案存在
- 確保 `data/raw/Dengue_Daily.csv` 檔案存在（用於計算完整病例數）
- 如果 GeoJSON 檔案不存在，系統會回退到使用 top30 資料

